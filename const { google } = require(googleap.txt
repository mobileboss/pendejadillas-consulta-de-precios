const { google } = require("googleapis");
const dropboxV2Api = require('dropbox-v2-api');
const fs = require('fs');
const path = require('path');

// Credenciales de Google Sheets (ya debes tenerlo)
const credentials = require("./pendejadillas-64b51618122f.json");

// ID y nombre de la hoja
const SPREADSHEET_ID = "1rLH1BqVhuetmlUcvWJEZwLUTUXtxbGkL6_vY7CdECQ8";
const SHEET_NAME = "Productos";

// Configuración Dropbox
const DROPBOX_ACCESS_TOKEN = "sl.u.AFlSPt_yWWmdOOm8PazAdTw3dYda39J2VOVEzxszaCCc31p0c__--lvUq6Ow9VipkvnsfL9Y1Yr53A-5zQMXAlPjScQkl90XwKNTJ9fZkRX181x4OEy_KBcKfqsyr-aQFHcKOHwZMs3buymb3eHJ3xcOvXvoZ-hhOdYZGho7SCw1Lv_mJ7QpbPt_DiKsaMPV_95MKIyuLzcmgXFr39e5bCTZVngSS_MUh2xaA9BLvne_F6WS7STzt15EU1fErsnQ_p8WHngIGTAN1UPVXZPFpJR-JI0CbxdVzNe_opqD_1UZsgZZamPQC3LAPallAET0N47_KCvSWyEtBcx24krQB-CBqVRMHXf7wnu7wwi1-Wb3akgD_Tgu-XeWCFRKWVJ5T2uuv3tMkkF18hQyzA4uFLBpmHOJRmpk3aezYFwMFyzma1Ef83KmVE_3yVE__080Zlrp0TpdCpqpiGsKcIz0uyBLFGrbrOOZGUXppLeWxN71_1uHTL0DUKeGchAHEh-72tOv5_ZopPNDdhUvJdHRd-ZjujgZNHup2jHzPPQzOk_8jkm5vAQvStlq1gLkg1SNowg3L_xH7MXjq5Rf3hDCJWMtUqK01Mu_zUFC0q4UBFSFtZCwoHI5j8Zc7jpqD2pIeszvTp9atxiHvGH87GQyDOMCHiLFOHVmSROMFHX69X3ODbHRdydWYPeNFQODz2EK-0Wj-tfXFibyXHNeg7S02FQcyj3MiR9p_9-3lXmNxY85qyxMP6RfHbetCYTBR9Gw1L2WTMWQTyq3PuA2Lht6Z2Eu9A1B3D4nrVJO5xXX76kIQmSFKz9Xv4SqlTmNNZ4CVBstRaCcjiYq6ypqxQ_y8LLliEWHXMuhBvBiL7BOtnQeL5AmBjHx9R7t17FDWOZhwAr_zssn8Z3fV9gkhvrZEqU_oBP0F2XeC6u_i-vM9lv4UrCXzJsEfY-ej3gu5UxWOsf7hS1U4aezNyl3F07jHWH7P6pidPr_AW3915Cn92N2tyM7Tg3IXiu2JRbTvF3cSjStO2Db7gikxqpE9hoW3EqqDwp3-AtHZO74dbmOG-7GQ6LajlOPmWKvrD2bG07VeJTww4R-yj7kp63bb17OWvsHxInirpsZ12FVYV3pVi8C-9Sjv0rnUfO8LqD0z6A4Y9a8K47hwsQ7TYHhLQdJ1kBMrM4EDk4vcC0Se3CfuJYJNiLELDj9Bo5Q5cQqGnbU0pR3cD381w-AgblJYLimJ0Px_WDp7SD7k7HXqhdoW79uCL9LoiS718zUOFpf8FAVyy6vhDMDoIkAxcknvj3yDMm2ALaQnEqXJzQbP7o-RddLu9OBGp3KDUPJQwEqCYrZnp8";  // Coloca el token aquí
const DROPBOX_FOLDER_PATH = "/CodigosBarras"; // Cambia si usaste otro nombre de carpeta

const dropbox = dropboxV2Api.authenticate({ token: DROPBOX_ACCESS_TOKEN });

// Autenticación Google Sheets
async function getSheetsClient() {
    const auth = new google.auth.GoogleAuth({
        credentials: credentials,
        scopes: ["https://www.googleapis.com/auth/spreadsheets"],
    });
    return google.sheets({ version: "v4", auth });
}

// Obtener links públicos de Dropbox
function getDropboxLinks() {
    return new Promise((resolve, reject) => {
        dropbox({
            resource: 'files/list_folder',
            parameters: { path: DROPBOX_FOLDER_PATH }
        }, (err, result) => {
            if (err) return reject(err);

            const linksPromises = result.entries.map(file => {
                return new Promise((resolveLink, rejectLink) => {
                    dropbox({
                        resource: 'sharing/create_shared_link_with_settings',
                        parameters: { path: `${DROPBOX_FOLDER_PATH}/${file.name}` }
                    }, (err, linkResult) => {
                        if (err && err.error?.shared_link_already_exists) {
                            dropbox({
                                resource: 'sharing/list_shared_links',
                                parameters: { path: `${DROPBOX_FOLDER_PATH}/${file.name}` }
                            }, (err, listResult) => {
                                if (err) return rejectLink(err);
                                resolveLink({
                                    sku: path.basename(file.name, '.png'),
                                    link: listResult.links[0].url.replace("?dl=0", "?raw=1")
                                });
                            });
                        } else if (linkResult) {
                            resolveLink({
                                sku: path.basename(file.name, '.png'),
                                link: linkResult.url.replace("?dl=0", "?raw=1")
                            });
                        } else {
                            rejectLink(err);
                        }
                    });
                });
            });

            Promise.all(linksPromises).then(resolve).catch(reject);
        });
    });
}

// Subir links a Google Sheets
async function updateSheet(links) {
    const sheets = await getSheetsClient();

    const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME}!A:E`
    });

    const rows = response.data.values || [];
    const skuRowMap = {};
    rows.forEach((row, index) => {
        const sku = row[0]?.trim();
        if (sku) {
            skuRowMap[sku] = index + 1;
        }
    });

    for (const { sku, link } of links) {
        const rowNumber = skuRowMap[sku];
        if (rowNumber) {
            await sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${SHEET_NAME}!E${rowNumber}`,
                valueInputOption: "USER_ENTERED",
                requestBody: { values: [[link]] }
            });
            console.log(`✅ Link actualizado para SKU: ${sku}`);
        } else {
            console.warn(`⚠️ No se encontró fila para SKU: ${sku}`);
        }
    }

    console.log("✅ Actualización completada.");
}

// Ejecución principal
(async () => {
    try {
        const links = await getDropboxLinks();
        await updateSheet(links);
    } catch (error) {
        console.error("❌ Error:", error);
    }
})();
